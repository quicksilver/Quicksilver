#!/usr/bin/env bash

set -Eeuf -o pipefail

xcodebuild -version

TOOLSDIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
readonly TOOLSDIR
. "${TOOLSDIR}/utils.sh"

cd "${TOOLSDIR}/.."

CONFIGURATION=${1-Release}

## Cache settings to save time
SETTINGS=/tmp/qs_build_settings
xcb_args=(
  -destination generic/platform=macos
  -configuration "${CONFIGURATION}"
  -scheme 'Quicksilver Distribution'
)
xcodebuild \
  "${xcb_args[@]}" \
  -showBuildSettings |
  sort -u > "${SETTINGS}"

# Copy library signing entitlements
cp Quicksilver.entitlements /tmp/Quicksilver.entitlements

SOURCE_ROOT=$(awk '$1 == "SOURCE_ROOT" { print $NF }' < "${SETTINGS}")
BUILT_PRODUCTS_DIR=$(awk '$1 == "BUILT_PRODUCTS_DIR" { print $NF }' < "${SETTINGS}")

# Tell xcode it's okay to clean these directories
build_parent=$(dirname "${BUILT_PRODUCTS_DIR}")
for build_dir in "${build_parent}" "${build_parent}/Debug" "${build_parent}/Release"; do
  test -e "${build_dir}" && xattr -w com.apple.xcode.CreatedByBuildSystem true "${build_dir}"
done

xcodebuild -scheme 'Quicksilver Distribution' clean

# Make sure `LOG` and its parents exist
mkdir -p "${BUILT_PRODUCTS_DIR}"
LOG=${BUILT_PRODUCTS_DIR}/build.log
touch "${LOG}"

{
  if [[ -z "${QS_DONT_TEST:-}" ]]; then
    "${TOOLSDIR}"/qstest
  fi

  if [[ "${CI:-}" = true ]] && [[ "${GITHUB_ACTIONS:-}" = true ]]; then
    xcb_args+=(CODE_SIGN_IDENTITY=-)
  fi
  xcodebuild \
    WARNING_CFLAGS="-w" \
    "${xcb_args[@]}" \
    build
} | tee "${LOG}"

## Build succeeded
pushd "${BUILT_PRODUCTS_DIR}"

## Set the correct plist permissions
chmod 644 Quicksilver.app/Contents/Info.plist

## Prepare the DMG directory
mkdir -p ./dmg
pushd ./dmg

cp -a ../Quicksilver.app .
cp "${SOURCE_ROOT}"/Resources/DMG_DS_Store ./.DS_Store
ln -sf /Applications .
cp "${SOURCE_ROOT}"/Resources/Images/QuicksilverDMG.icns ./.VolumeIcon.icns

# Use an ad-hoc sig by default; follow with qssign if a production signature is required
codesign --deep --force --sign "-" Quicksilver.app

popd

echo "Creating a zip build artifact for uploading."
ditto -c -k --keepParent Quicksilver.app Quicksilver.zip

# Clean up settings if all went well
rm -f -- "${SETTINGS}"
