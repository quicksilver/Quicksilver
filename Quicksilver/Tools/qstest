#!/usr/bin/env bash
# USAGE: qstest scheme [...]
# EXAMPLE: qstest "QuickStep Core" "QuickStep Foundation" "Core Support"
# To build a testing config but not run tests: QS_DONT_TEST=1 ./qstest ...

set -euf

log() {
  scriptname=$(basename "$0")
  printf '%s: %s\n' "${scriptname}" "$*" > /dev/stderr
}

CURRENT_ARCH=$(uname -m)
readonly CURRENT_ARCH

TOOLSDIR=$(cd "$(dirname "$0")" && pwd)
readonly TOOLSDIR

main() {
  if test -z "${1:-}"; then
    set -- "QuickStep Core" "QuickStep Foundation" "Core Support" "Quicksilver"
  fi

  cd "${TOOLSDIR}/.."

  local xcb_args=(
    -project "${TOOLSDIR}"/../Quicksilver.xcodeproj
    -destination "platform=macOS,arch=${CURRENT_ARCH}"
    -configuration Testing
    GCC_PREPROCESSOR_DEFINITIONS="TESTING"
  )
  if [[ "${CI:-}" = true ]] && [[ "${GITHUB_ACTIONS:-}" = true ]]; then
    xcb_args+=(CODE_SIGN_IDENTITY=-)
  fi
  xcodebuild build \
    -scheme Quicksilver \
    "${xcb_args[@]}"

  # Having a `Testing` config built but not yet run can be nice for selecting a
  # target for `Instruments.app`
  if [[ -n "${QS_DONT_TEST:-}" ]]; then
    echo "Skipping tests"
    return 0
  fi

  echo "RUNNING UNIT TESTS..."

  retval=0
  for scheme; do
    log "beginning tests for scheme: ${scheme}"
    xcodebuild test \
      -scheme "${scheme}" \
      "${xcb_args[@]}"

    if [[ "${retval}" -ne 0 ]]; then
      log "testing ${scheme} failed with exit code ${retval}"
      return "${retval}"
    fi

    log "testing succeeded for scheme: ${scheme}"
  done
}

main "$@"
